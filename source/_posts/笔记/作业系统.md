---
title: 作业系统
date: 2020-11-14 19:14:20
tags: 课程笔记
mathjax: true
---
[OS成绩](https://docs.google.com/spreadsheets/d/1wfQxRlxZrXg_BedkDZgvDrQPnWJ9lQaNv2-YBIjzckE/edit#gid=0)

[筆記github](https://kim85326.github.io/category/#%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1)	[筆記2宅學習](https://sls.weco.net/node/21325)

## ch1 OS

- OS的作用 -2
  - resource allocator
  - control program
- kernel
  - 一個位於電腦OS核心的程式 a program at the core of computer's OS
- bootstrap program
  - 放在ROM、EEPROM中，視爲firmware
  - 作用
    - 設定系統參數初值
    - load OS from hard disk to memory then exe.
- interrupt
  - trap：当使用者呼叫system call时，軟件產生的中斷
  - hardware interrupt：I/O request or completion
  - software interrupt：system call
- network
  - LAN：ex. campus
  - WAN
- 計算機系統的運作
  - ![image-20201015120130733](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193713.png)
  - DMA：what device controller do
- 計算機系統架構
  - Single-Processor System
    - ![image-20201015120251643](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193714.png)
  - Multiprocessor：多個processor，公用memory
    - most common system：SMP(Symmetric multi-processing)
    - ![image-20201110160204556](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193715.png)
  - Multicore
    - ![image-20201110160238381](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193716.png)
    - processor 和 chip 主要是表达侧重点不同，processor更强调功能，chip就是肉眼看到的芯片
  - Cluster System（集成式系統）：通過網路將電腦連成集成，共同分享存儲裝置
    - asymmetric clustering：一臺機器hot-standby mode監督server工作，其餘執行應用程序
    - parrallel clustering：一起執行與監督
  - Distributed System：每個processor都有自己的memory，機器間用network連接
- 操作系統的運作
  - Multiprogramming：通過CPU scheduling對process排程，儅process有需要了才會interrupt CPU，減少了CPU等待process的時間，讓CPU一直忙碌于運行程式
    - 拓展出的概念Multitasking：CPU在多個process中間來回切換，以提供用戶快速的response
  - Time sharing：OS让很多process可以同时执行，让process能被公平的执行到，隔段时间就interrupt 触发context switch
  - Dual-Mode Operation（雙模式運作）：user mode + kernel mode，以划分os code和user-defined code
    - ![image-20201110162112523](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193717.png)
  - Timer：設置時間限制去終止程式，防止無窮回圈
- OS作用for Resource Management
  - Process Management（行程管理）：新增刪除行程、排程、暫停恢復行程、process synchronization、process communication
  - Memory Management（記憶體管理）
  - File-System Management（儲存體管理）
  - Mass-Storage Management：磁盤的管理
  - Cache Management
  - I/O System Management：OS會隱藏特定的I/O devices from user，并只讓相關的device driver知道
- Computing -3
  - Client-Server
  - Pearso-to-Pear（P2P）
  - Cloud

## ch2 OS

- OS service
  - ![img](https://i.imgur.com/OFzXWXl.png)
  - batch（批處理）
  - accounting：記錄哪些user用了哪些resource
  - system call
    - 提供作業系統服務界面。通過呼叫OS跳到kernel mode，做完後return回system call interface
    - 參數傳遞的三種方式
      - register：Pass parameters in registers
      - block：Registers pass starting addresses of blocks of parameter
      - stack：Parameters pushed onto the stack, and popped off
    - 功能
      - process control
      - file management
      - device management
      - information maintenance
      - communication
        - 兩個基本模型
          - message-passing model：messages exchaged through a common mailbox，no conflict
          - shared-memory model：直接獲取access to其他process的memory，max speed適合大數據交換
      - protection
- OS架構
  - monolithic structure：包含了所有system call裏面的東西
  - Layer Approach（分層方法）：結構簡單用於除錯
  - Microkernels：排除OS非必要的元件，用massage passing溝通
  - Modules

## ch3 Multiprocess

- Process
  - Stack：temporary data(fuction, local variables)
  - data section：global variales
  - heap：dynamic allocation
  - text：executable code
- PCB：在OS中代表一个process的kernel data structure，存放了进程所需的信息
  - Process State
  - program counter
  - CPU register
  - Information
    - I/O status information
    - CPU-Scheduling
    - Memory-management
    - Accounting：CPU数量，运行时间
- state
  - ![image-20201028013227682](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193718.png)
- Process Creation
  - ![image-20201028013130182](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193719.png)
- process scheduler：在core上选择可执行的程式process
- ready queue：行程waiting和ready的地方
- Context Switch
  - ![image-20201028013156718](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193720.png)
- degree of mutiprogramming: memory中排的行程数
- IPC（Interporcess Communication）
  - shared memory
    - API（应用程式界面）由POSIX（可移植作业系统界面）提供
    - 由buffer存放shared memory region
      - unbounded buffer
      - bounded buffer：有size限制，读空时不能再读，写满时不能再写
    - 有互斥性（conflix），速度快，适合分布式环境可通过网路连接不同的计算机
  - massage passing
    - 通过system call实现，需使用更久的kernel
    - types
      - dirrect communication: naming发送及接收方，通过communication link直接传递至process
      - indirrect communication: 由两方的mailbox/ports进行传递
- pipe：在Linux中pipe()是system call，属于一种massage passing，用数据线传递
  - ordinary: 用于parent-child relationship process
  - named：more general，多行程通信
- client-server communicaiton forms
  - socket：允许行程通过网路通信，有独立的ip和port number，属于named pipe
  - RPCs（remote procedure call）：每个消息都独立完整

## ch4 Thread

- thread
  - thread id
  - program counter
  - register
  - stack
- pthread: POSIX綫程
- concurrency：运用在单核，将CPU运行时间段分配给各线程，并不能真正同时进行线程
- parallelism：运用在多核，多线程同时进行
  - data parrallelism
  - task parrallelism
  - ![image-20201028093510393](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193721.png)
- Amdahl's law：$speedup\leqq\frac{1}{S+(1-S)/N}$ 
  - S：serial占比，1-S：parallel占比
  - N：cores数
- user thread：由app做出，由thread library控制
- kernel thread：由OS控制
- Multithreading Model
  - ![image-20201110174711726](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193722.png)
    - 此处PC为program counter
  - Many-to-One Model：多user thread争用一个kernel thread，即使多核也无法平行执行，不快
  - One-to-One：缺点是会产生过多的kernel thread
  - Many-to-Many
  - Two-level：既有Many-to-Many，又有One-to-One
- LWP（light weight process）：中间数据结构放在user和kernel间，比如Many-to-Many和Two-level
  - ![image-20201105112833536](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193723.png)
- TLS（thread-local storage）：thread一般共享process的数据，但也可能会需要自己的空间
- scheduler activation：communication between user-thread library and kernel's
- creating multiple thread
  - asynchronous threading：parrent create child后，两者独立运行，用于感应式用户界面
  - synchronous threading：parrent 等待child完成后才会继续运行，用于需要分享重要数据的情形
- Implicit threading：将线程的产生与管理从 app developer 转到 compiler（编译器） & run-time library（运行时库）
  - thread pool
  - fork-join：parrent thread产生task，等执行完后再join起来，使result可被找回
  - OpenMP（open multi-processing）：支持跨平台共享内存的多线程编程API
  - GCD（Grand Central Dispatch）：识别运行的parallel tasks放入dispatch queue中管理
  - TBB（Intel Thread Building Block）：library支持设计平行app，类似fork-join的方法

## ch5 CPU Scheduling

[CPU调度笔记](https://zhuanlan.zhihu.com/p/36142302)

- CPU Scheduling：Scheduler是一种OS function
  - preeptive scheduling：发生于interrupt和I/O completion
  - nonpreeptive scheduling：发生于I/O wait和terminate
- Dispatcher：一种OS function，把CPU core的控制权交给Scheduler选出的process
  - dispatch latency：停止一个process并切换到另一个process中间所花的时间
- Criteria -5
  - CPU utilization
  - Throughput 通量：单位时间process完成量
  - Turnaround time 周转时间：运行process的时间
  - waiting time
  - Response time
- perdict next CPU burst：$τ_{n+1}=\alpha t+(\alpha -1)τ_{n}$
- 基本的Algorithm
   - FCFS (First-Come First-Served Scheduling)
   - SJF (Shortest-Job-First Scheduling)
   - RR (Round-Robin Scheduling)
     - 在FCFS的基础上，分配每个行程time quantum进行行程的切换
     - time quantum large → FCFS，time quantum small → processor sharing
   - Priority Scheduling
     - 按照priority分配CPU，priority相同时按FCFS
     - 缺点：indefinite blocking/starvation，即低优先权的行程可能永远不会轮到
     - 解决方案
       1. aging：随着时间等待，提升priority
       2. RR+priority
          - highest priority process会运行完整不参与RR
          - 两个next-highest priority会用RR轮流运行，当其中一个运行完后，另一个会升为最高优先权来运行
   - Multilevel Queue Scheduling
     - 按进程属性分成不同priority的队列，各队列使用不同的算法排序
   - Multilevel Feedback Queue Scheduling
     - 进程可以在队列中移动。执行太久的进程会被丢到低优先权的队列，太久没被执行的进程则会被丢到高优先权的队列
   - Thread Scheduling
     - PCS (Procss-Contention Scope)行程争用：user-level thread争用LWP，由线程库选择
     - SCS (System-Contention Scope)系统争用：kernel-level thread争用CPU，one-to-one model仅存在系统争用
     - Pthread Scheduling：用的就是contention scope
   - Muli-Processor Scheduling
     - multiprocessor
       - multicore
       - multi-threaded cores
         - ![image-20201110201115649](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193724.png)
       - NUMA（non-uniform memory access）非统一内存访问架构：一种多处理的内存架构，属于SMP
       - heterogenous multiprocessing 异质多处理器系统：将不同工作性质的处理器整合唯一的处理系统
     - asymmetric multiprocessing：由一个process core主导所有的存取data
     - symmetric multiprocessing（SMP）：processor self-schduling
     - CMT（chip multithread）：multithread交错运行，以减少全部等待stall的时间
       - ![image-20201110200925194](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193725.png)
       - memory stall记忆停滞：processor会花很多时间在等待data可使用，因processor的速度通常会比memory的速度快
     - HMP（Heterogeneous Multiprocessing）：将任务分配给特定的内核来更好的管理功耗
- Real-time CPU：priority-based algorithm，process会间歇性的需要CPU-admission-control algorithem来实现deadline
   - soft real-time system：只保证尽量完成，越关键的行程越优先，real-time tast优先于non-real-time
   - hard real-time system：行程一定会在deadline前完成
   - event latency：事件发生到它被服务的时间段
      - ![image-20201110213048989](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193726.png)
   - Rate Monotonic Scheduling速率单调算法排程
      - 依据周期长短来排程，周期越短优先权越高
      - worst-case CPU utilization = $N(2^\frac{1}{N} -1)$    N: process数
      - 缺点：可能会miss deadline，因周期结束前行程未被排完
   - EDF（Earliest-Deadline-First Scheduling）
      - 理论上是最佳的，可满足deadline要求，CPU利用率100%
   - Proportional Share Scheduling
      - 按分享比例分配CPU时间
   - POSIX Real-time Scheduling
      - FIFO+RR
      - linux的算法
- Little's formula：n = λ × w
   - 到达queue的新行程数 = queue中新行程的平均达到率 × process waits
   - 可用于arrival distribution进而simulation

## ch6 Synchronization tool

- Synchronization tool：race condition会引发同步问题
- critical section：一段特定区域，同一时间只允许一个process使用
  - ![image-20201110222750328](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201114193727.png)
  - entry section：允许process request的code section
- 解决critical section problem的条件
  1. mutual exclusive（mutex）
  2. progress：选择需要critical section的process进入
  3. bounded waiting：等待是有限期的
- Peterson's Solution：software-based solution
  - flag[]
  - var turn
- Hardware solution
  - memory model：决定memory如何配给app
    - Strongly ordered：行程的记忆改变对于其他行程而言是立马可知的
    - Weakly ordered
  - test and set()
  - caompare and swap () （CAS）
    - 始终返回可变值的初始值
    - 执行顺序是任意的
    - var atomic（原子变量）实现了mutual exclusive ，例如：计数器记录更改次数来阻止发生多个process同时进入临界区
- Mutex - Higher level software tool：是可被应用程序员访问的
  - Mutex是一把钥匙，一个人拿了就可以进一个房间，出来的时候把钥匙交给队列的第一个
  - mutex locks
  - acquire()：acquire lock
  - release()：release lock
  - var lock：来判断lock是否已正被运行
  - 缺点：busy waiting
- Semaphore：解决busy waiting的问题
  - Semaphore是一个可容纳N人的空间，如果人不满可以进去，如果人满了，就要等人出来
  - wait()
  - signal()：让process从wait状态转到ready queue
  - counting semaphore：可以是任意值
  - binary semaphore：只有0、1
  - 可记录某一资源剩下多少数目可使用，若全使用，则需要等待资源被释放
  - busy waiting从entry section移至critical section，critical section区块相对而言更空闲些
- Monitor Type：可用于使用高级指令来解决同步工具的error
  - 属于ADT（Abstract data type）抽象数据类型
  - ADT：用函数封装数据，使数据操作独立于ADT
- Liveness
  - liveness failure：process永远wait
    - deadlock
    - priority inversion优先级倒置

## ch8 Deadlock

[ch8笔记](http://www.csie.ntnu.edu.tw/~swanky/os/chap5.htm)

- lock
  - deadlock：会导致throuphput↓，CPU utilization↓
    - mutex lock
    - semaphore
  - livelock
- deadlock四必条件
  - mutual exclusion
  - hold and wait
  - no preemption
  - circular wait

- deadlock解决方式
  - 无视
  - deadlock prevention
  - deadlock avoidance：Banker‘s algorithm
  - deadlock detection
- Banker's algorithm
- Safety algorithm
- Deadlock Detection Algorithm

## ch9 Memory Management

- base register：用于记录进程的起始记忆体地址
- limit register：记录地址范围
- ![image-20201204144130891](C:\Users\AAA\AppData\Roaming\Typora\typora-user-images\image-20201204144130891.png)
- MMU（memory management unit）：通过硬体实现run-time mapping，从logical→physical![image-20201204143357195](C:\Users\AAA\AppData\Roaming\Typora\typora-user-images\image-20201204143357195.png)
- Fragmentaion
  - 50-percent rule
  - solutions：Compaction、noncontiguous logical address space of process
    - external：paging
    - internal：segmentation
- Paging：管理memory，提升资源利用率
  - page table：位于main memory的PRBR（page-table base register）内![image-20201204141710012](https://cdn.jsdelivr.net/gh/ronyeaf/asset/img/20201204141724.png)
  - frame table：allocation details of physical memory，比如哪些frame是已被分配的，哪些没有
  - TLB translation look-aside buffer：access memory会分为access page-table entry+access the actual data，通过提升硬件Cache支援，associative高速内存，来提升速度。
- Swapping<br>![image-20201204142348507](C:\Users\AAA\AppData\Roaming\Typora\typora-user-images\image-20201204142348507.png)
- Segmentation：使使用者的view一致

## ch10 Virtual Machine

- virtual memory：在program看来是连续的记忆体，但实际分割成多个实体记忆体碎片
- 使用paging和COW（copy-on-write）写入时复制
- Page Replacement
  - FIFO
  - Optimal
  - LRU
  - LRU-Approximation：用reference bit记录过去使用过哪些分页
  - Counting-Based Page Replacement
    - LFU
    - MFU
  - Page-Buffering Algorithms
  - Applications and PAge Replacement
- page fault：page table无法找到对应的frame
  - sol：OS需要进入disk查找资料，将资料搬入memory中，生成新的page table，再另process重新进入工作。

[ch9-10考古](https://ithelp.ithome.com.tw/articles/10229522)



[ch3-4作業系統考古](https://ithelp.ithome.com.tw/articles/10229521)

[課本excercise answer](http://www.salimarfaoui.com/Com310Lectures/Ch2ReviewQuestionsWAnswers.pdf)

[小考重點考題整理](https://ithelp.ithome.com.tw/articles/10228947)


